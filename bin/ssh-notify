#!/bin/bash
# ssh-notify - SSH wrapper with reverse port forwarding for notifications
# Part of terminal-notifier-for-macos
#
# Usage: ssh-notify [SSH_OPTIONS] user@host
#
# This wraps SSH and adds reverse port forwarding so that the remote
# server can send notifications back to your local Mac.

set -euo pipefail

PORT="${TNOTIFY_PORT:-9999}"

# Find the installation directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

usage() {
    cat << EOF
Usage: ssh-notify [OPTIONS] [user@]host [command]

SSH wrapper with automatic reverse port forwarding for terminal notifications.

This command wraps SSH and adds -R ${PORT}:localhost:${PORT} to enable
notifications from the remote server to reach your local Mac.

Options:
  --setup           Copy shell hooks to remote server after connecting
  --no-forward      Connect without port forwarding (regular SSH)
  -h, --help        Show this help

All other options are passed directly to SSH.

Examples:
  ssh-notify user@server.com
  ssh-notify --setup user@server.com    # First-time setup
  ssh-notify -p 2222 user@server.com    # Custom SSH port

Environment:
  TNOTIFY_PORT      Notification server port (default: 9999)

Remote Setup:
  After connecting with --setup, source the shell hooks in your remote shell:
    echo 'source ~/.tnotify/shell-hooks.zsh' >> ~/.zshrc
  or for bash:
    echo 'source ~/.tnotify/shell-hooks.bash' >> ~/.bashrc
EOF
    exit 0
}

setup_remote=0
no_forward=0
ssh_args=()

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --setup)
            setup_remote=1
            shift
            ;;
        --no-forward)
            no_forward=1
            shift
            ;;
        -h|--help)
            usage
            ;;
        *)
            ssh_args+=("$1")
            shift
            ;;
    esac
done

if [[ ${#ssh_args[@]} -eq 0 ]]; then
    echo "Error: No host specified" >&2
    echo "Usage: ssh-notify [OPTIONS] [user@]host" >&2
    exit 1
fi

# Build SSH command
ssh_cmd=(ssh)

# Add reverse port forwarding unless disabled
if [[ "$no_forward" != "1" ]]; then
    ssh_cmd+=(-R "${PORT}:localhost:${PORT}")
fi

# Add user arguments
ssh_cmd+=("${ssh_args[@]}")

# If setup requested, copy files first then connect
if [[ "$setup_remote" == "1" ]]; then
    # Extract host from args (simplified - assumes last arg without - is the host)
    remote_host=""
    for arg in "${ssh_args[@]}"; do
        if [[ "$arg" != -* ]]; then
            remote_host="$arg"
            break
        fi
    done

    if [[ -z "$remote_host" ]]; then
        echo "Error: Could not determine remote host for setup" >&2
        exit 1
    fi

    echo "Setting up terminal-notifier on $remote_host..."

    # Create remote directory
    ssh "$remote_host" "mkdir -p ~/.tnotify/bin"

    # Copy tnotify client
    scp -q "$SCRIPT_DIR/tnotify" "${remote_host}:~/.tnotify/bin/"
    ssh "$remote_host" "chmod +x ~/.tnotify/bin/tnotify"

    # Copy shell hooks
    scp -q "$LIB_DIR/shell-hooks.zsh" "${remote_host}:~/.tnotify/"
    scp -q "$LIB_DIR/shell-hooks.bash" "${remote_host}:~/.tnotify/"

    # Add tnotify to PATH in remote shell
    ssh "$remote_host" 'grep -q "/.tnotify/bin" ~/.bashrc 2>/dev/null || echo "export PATH=\"\$HOME/.tnotify/bin:\$PATH\"" >> ~/.bashrc'
    ssh "$remote_host" 'grep -q "/.tnotify/bin" ~/.zshrc 2>/dev/null || echo "export PATH=\"\$HOME/.tnotify/bin:\$PATH\"" >> ~/.zshrc'

    echo "Setup complete!"
    echo ""
    echo "To enable notifications on the remote server, add one of these to your remote shell config:"
    echo "  For zsh:  source ~/.tnotify/shell-hooks.zsh"
    echo "  For bash: source ~/.tnotify/shell-hooks.bash"
    echo ""
    echo "Connecting..."
    echo ""
fi

# Execute SSH
exec "${ssh_cmd[@]}"
