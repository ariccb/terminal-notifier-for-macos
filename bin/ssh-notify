#!/bin/bash
# ssh-notify - SSH wrapper with reverse port forwarding for notifications
# Part of terminal-notifier-for-macos
#
# Usage: ssh-notify [SSH_OPTIONS] user@host
#
# This wraps SSH and adds reverse port forwarding so that the remote
# server can send notifications back to your local Mac.

set -euo pipefail

PORT="${TNOTIFY_PORT:-9999}"

# Find the installation directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LIB_DIR="$(dirname "$SCRIPT_DIR")/lib"

usage() {
    cat << EOF
Usage: ssh-notify [OPTIONS] [user@]host [command]

SSH wrapper with automatic reverse port forwarding for terminal notifications.

This command wraps SSH and adds -R ${PORT}:localhost:${PORT} to enable
notifications from the remote server to reach your local Mac.

Options:
  --setup           Copy shell hooks to remote server after connecting
  --no-forward      Connect without port forwarding (regular SSH)
  -h, --help        Show this help

All other options are passed directly to SSH.

Examples:
  ssh-notify user@server.com
  ssh-notify --setup user@server.com    # First-time setup
  ssh-notify -p 2222 user@server.com    # Custom SSH port

Environment:
  TNOTIFY_PORT      Notification server port (default: 9999)

Remote Setup:
  After connecting with --setup, source the shell hooks in your remote shell:
    echo 'source ~/.tnotify/shell-hooks.zsh' >> ~/.zshrc
  or for bash:
    echo 'source ~/.tnotify/shell-hooks.bash' >> ~/.bashrc
EOF
    exit 0
}

setup_remote=0
no_forward=0
ssh_args=()
ssh_opts_for_scp=()
remote_host=""

# SSH options that take an argument
ssh_opts_with_arg="-b -c -D -E -e -F -I -i -J -L -l -m -O -o -p -Q -R -S -W -w"

# Parse arguments
while [[ $# -gt 0 ]]; do
    case "$1" in
        --setup)
            setup_remote=1
            shift
            ;;
        --no-forward)
            no_forward=1
            shift
            ;;
        -h|--help)
            usage
            ;;
        -i|-p|-F|-o|-J)
            # SSH options we need to pass to both ssh and scp
            ssh_args+=("$1" "$2")
            ssh_opts_for_scp+=("$1" "$2")
            shift 2
            ;;
        -*)
            # Check if this option takes an argument
            if [[ " $ssh_opts_with_arg " == *" $1 "* ]]; then
                ssh_args+=("$1" "$2")
                shift 2
            else
                ssh_args+=("$1")
                shift
            fi
            ;;
        *)
            # Positional argument - this is the host (or command)
            remote_host="$1"
            ssh_args+=("$1")
            shift
            ;;
    esac
done

if [[ -z "$remote_host" ]]; then
    echo "Error: No host specified" >&2
    echo "Usage: ssh-notify [OPTIONS] [user@]host" >&2
    exit 1
fi

# Build SSH command
ssh_cmd=(ssh)

# Add reverse port forwarding unless disabled
if [[ "$no_forward" != "1" ]]; then
    ssh_cmd+=(-R "${PORT}:localhost:${PORT}")
fi

# Add user arguments
ssh_cmd+=("${ssh_args[@]}")

# If setup requested, copy files first then connect
if [[ "$setup_remote" == "1" ]]; then
    if [[ -z "$remote_host" || "$remote_host" == -* ]]; then
        echo "Error: Could not determine remote host for setup" >&2
        exit 1
    fi

    echo "Setting up terminal-notifier on $remote_host..."

    # Create remote directory
    ssh "${ssh_opts_for_scp[@]}" "$remote_host" "mkdir -p ~/.tnotify/bin"

    # Copy tnotify client
    scp -q "${ssh_opts_for_scp[@]}" "$SCRIPT_DIR/tnotify" "${remote_host}:~/.tnotify/bin/"
    ssh "${ssh_opts_for_scp[@]}" "$remote_host" "chmod +x ~/.tnotify/bin/tnotify"

    # Copy shell hooks
    scp -q "${ssh_opts_for_scp[@]}" "$LIB_DIR/shell-hooks.zsh" "${remote_host}:~/.tnotify/"
    scp -q "${ssh_opts_for_scp[@]}" "$LIB_DIR/shell-hooks.bash" "${remote_host}:~/.tnotify/"

    # Add tnotify to PATH in remote shell
    ssh "${ssh_opts_for_scp[@]}" "$remote_host" 'grep -q "/.tnotify/bin" ~/.bashrc 2>/dev/null || echo "export PATH=\"\$HOME/.tnotify/bin:\$PATH\"" >> ~/.bashrc'
    ssh "${ssh_opts_for_scp[@]}" "$remote_host" 'grep -q "/.tnotify/bin" ~/.zshrc 2>/dev/null || echo "export PATH=\"\$HOME/.tnotify/bin:\$PATH\"" >> ~/.zshrc'

    echo "Setup complete!"
    echo ""
    echo "To enable notifications on the remote server, add one of these to your remote shell config:"
    echo "  For zsh:  source ~/.tnotify/shell-hooks.zsh"
    echo "  For bash: source ~/.tnotify/shell-hooks.bash"
    echo ""
    echo "Connecting..."
    echo ""
fi

# Execute SSH
exec "${ssh_cmd[@]}"
